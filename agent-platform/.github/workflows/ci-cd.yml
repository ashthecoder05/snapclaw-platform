name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  ACR_NAME: agentplatformacr
  RESOURCE_GROUP: agent-platform-rg

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -r agent-runtime/requirements.txt
        pip install -r control-api/requirements.txt

    - name: Run tests
      run: |
        # Add tests when created
        echo "Tests would run here"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build and push agent image
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/agent:${{ github.sha }} ./agent-runtime
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/agent:latest ./agent-runtime
        docker push ${{ env.ACR_NAME }}.azurecr.io/agent:${{ github.sha }}
        docker push ${{ env.ACR_NAME }}.azurecr.io/agent:latest

    - name: Build and push control-api image
      run: |
        # Create Dockerfile
        cat > control-api/Dockerfile << 'EOF'
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY . .
        RUN useradd -m -u 1000 apiuser && chown -R apiuser:apiuser /app
        USER apiuser
        EXPOSE 8000
        CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
        EOF

        docker build -t ${{ env.ACR_NAME }}.azurecr.io/control-api:${{ github.sha }} ./control-api
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/control-api:latest ./control-api
        docker push ${{ env.ACR_NAME }}.azurecr.io/control-api:${{ github.sha }}
        docker push ${{ env.ACR_NAME }}.azurecr.io/control-api:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name agent-platform-aks

    - name: Deploy to AKS
      run: |
        # Update control API
        kubectl set image deployment/control-api control-api=${{ env.ACR_NAME }}.azurecr.io/control-api:${{ github.sha }} -n platform

        # Wait for rollout
        kubectl rollout status deployment/control-api -n platform